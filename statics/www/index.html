<!doctype html>
<html lang="es">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Tailon Console</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap">
        <link rel="stylesheet" href="lib/hc-design.css" />
        <!-- Tailwind (CDN build) -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
                // minimal dark palette tweaks
                tailwind.config = {
                        theme: {
                                extend: {
                                        colors: {
                                                brand: {
                                                        50: '#f4f6ff',
                                                        100: '#e6e9ff',
                                                        200: '#c8d0ff',
                                                        300: '#a9b6ff',
                                                        400: '#899aff',
                                                        500: '#5666f5',
                                                        600: '#3a4be6',
                                                        700: '#2736c2',
                                                },
                                                accent: '#ff7a59',
                                                surface: '#ffffff',
                                                neutral: {
                                                        50: '#f8fafc',
                                                        100: '#f1f5f9',
                                                        600: '#475569',
                                                        900: '#0f172a',
                                                },
                                        },
                                },
                        },
                        darkMode: 'media',
                }
        </script>
        <style>
                body {
                        background: radial-gradient(circle at 10% 20%, rgba(86, 102, 245, 0.12), transparent 35%),
                                radial-gradient(circle at 80% 0%, rgba(255, 122, 89, 0.14), transparent 32%),
                                var(--color-background);
                        color: var(--color-text-strong);
                }

                .app-shell {
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        background-color: color-mix(in srgb, var(--color-surface) 85%, transparent);
                        border: 1px solid var(--color-border-subtle);
                        box-shadow: var(--shadow-lg);
                        border-radius: 1.25rem;
                        overflow: hidden;
                }

                .sidebar-panel {
                        background: linear-gradient(180deg, rgba(86, 102, 245, 0.08), rgba(15, 23, 42, 0.02));
                        border-right: 1px solid var(--color-border-subtle);
                        backdrop-filter: blur(6px);
                }

                .pill {
                        display: inline-flex;
                        align-items: center;
                        gap: 0.35rem;
                        padding: 0.35rem 0.7rem;
                        border-radius: 9999px;
                        background: rgba(86, 102, 245, 0.12);
                        color: var(--color-brand-700);
                        font-weight: 600;
                        font-size: 0.85rem;
                }

                .card-muted {
                        border: 1px solid var(--color-border-subtle);
                        background: color-mix(in srgb, var(--color-surface) 92%, transparent);
                        border-radius: var(--radius-lg);
                        box-shadow: var(--shadow-sm);
                }

                .list-tile:hover {
                        background-color: rgba(86, 102, 245, 0.08);
                }

                .code-block {
                        background: #0b1220;
                        color: #e2e8f0;
                        border-radius: var(--radius-lg);
                        border: 1px solid rgba(148, 163, 184, 0.24);
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
                }

                .mono {
                        font-family: "JetBrains Mono", SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
                }
        </style>
	<!-- Vue 3 + Router (ESM via CDN) -->
	<!-- Import Map to resolve bare specifiers -->
	<script type="importmap">
		{
			"imports": {
				"vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
				"vue-router": "https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js",
				"@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.5.0/lib/esm/index.js"
			}
		}
	</script>
	<script type="module">
		import { createApp, reactive, ref, computed, onMounted, watch } from 'vue'
		import { createRouter, createWebHashHistory, useRouter, useRoute } from 'vue-router'

		// --- Simple global store ---
		const store = reactive({
			baseUrl: 'http://localhost:8080',
			extraHeaderName: localStorage.getItem('tailon.headerName') || '', // e.g., 'X-Auth'
			extraHeaderValue: localStorage.getItem('tailon.headerValue') || '',
			queues: [],
			loadingQueues: false,
			selectedQueue: null,
			// Live stream state
			live: {
				controller: null,
				running: false,
				lines: [], // parsed JSON lines
				raw: '',   // raw text buffer (debug)
				error: '',
			},
		})

		// --- HTTP helpers ---
		function headersJSON() {
			const h = { 'Accept': 'application/json', 'Content-Type': 'application/json' }
			if (store.extraHeaderName && store.extraHeaderValue) h[store.extraHeaderName] = store.extraHeaderValue
			return h
		}
		function headersAny(accept = '*/*') {
			const h = { 'Accept': accept }
			if (store.extraHeaderName && store.extraHeaderValue) h[store.extraHeaderName] = store.extraHeaderValue
			return h
		}
		async function httpGet(path, accept = 'application/json') {
			const res = await fetch(`${store.baseUrl}${path}`, { headers: headersAny(accept) })
			if (!res.ok) throw new Error(`GET ${path} → ${res.status}`)
			if (accept === 'application/json') return res.json()
			return res.text()
		}
		async function httpPost(path, body, contentType = 'application/json') {
			const headers = headersAny('application/json')
			headers['Content-Type'] = contentType
			const res = await fetch(`${store.baseUrl}${path}`, { method: 'POST', headers, body })
			if (!res.ok) throw new Error(`POST ${path} → ${res.status}`)
			const ct = res.headers.get('content-type') || ''
			return ct.includes('application/json') ? res.json() : res.text()
		}
		async function httpDelete(path) {
			const res = await fetch(`${store.baseUrl}${path}`, { method: 'DELETE', headers: headersAny('application/json') })
			if (!res.ok) throw new Error(`DELETE ${path} → ${res.status}`)
			const ct = res.headers.get('content-type') || ''
			return ct.includes('application/json') ? res.json() : res.text()
		}

		// --- API wrappers (per OpenAPI) ---
		async function listQueues() {
			store.loadingQueues = true
			try {
				const data = await httpGet('/v1/queues') // array<string>
				store.queues = Array.isArray(data) ? data : []
			} finally {
				store.loadingQueues = false
			}
		}
		async function createQueue(name) {
			await httpPost('/v1/queues', JSON.stringify({ name }))
			await listQueues()
		}
		async function deleteQueue(id) {
			await httpDelete(`/v1/queues/${encodeURIComponent(id)}`)
			if (store.selectedQueue === id) store.selectedQueue = null
			await listQueues()
		}

		// --- Streaming read (JSONL) ---
		async function readJSONLStream(queueId, { onLine, maxLines = Infinity, timeoutMs = 30000 } = {}) {
			// Abort any previous live
			if (store.live.controller) {
				try { store.live.controller.abort() } catch {}
			}
			store.live.controller = new AbortController()
			const { signal } = store.live.controller
			const url = `${store.baseUrl}/v1/queues/${encodeURIComponent(queueId)}:read`
			const res = await fetch(url, { headers: headersAny('*/*'), signal })
			if (!res.ok) throw new Error(`READ ${url} → ${res.status}`)

			const reader = res.body.getReader()
			const decoder = new TextDecoder()
			let buffer = ''
			let count = 0
			let timer
			const resetTimer = () => {
				if (timeoutMs !== Infinity) {
					if (timer) clearTimeout(timer)
					timer = setTimeout(() => {
						try { store.live.controller.abort() } catch {}
					}, timeoutMs)
				}
			}
			resetTimer()

			try {
				while (true) {
					const { value, done } = await reader.read()
					if (done) break
					resetTimer()
					buffer += decoder.decode(value, { stream: true })
					let idx
					while ((idx = buffer.indexOf('\n')) >= 0) {
						const line = buffer.slice(0, idx)
						buffer = buffer.slice(idx + 1)
						if (line.trim().length === 0) continue
						count++
						try {
							const obj = JSON.parse(line)
							onLine && onLine(obj, line)
						} catch (e) {
							// Non-JSON line; pass raw
							onLine && onLine({ _raw: line }, line)
						}
						if (count >= maxLines) {
							try { store.live.controller.abort() } catch {}
							return
						}
					}
				}
			} finally {
				if (timer) clearTimeout(timer)
			}
		}

		// --- Write (single JSON message) ---
		async function writeJSONLine(queueId, jsonText, contentType = 'application/json') {
			// Append a newline to respect JSONL contract
			const body = contentType === 'application/json' ? (jsonText.trim() + '\n') : jsonText
			return httpPost(`/v1/queues/${encodeURIComponent(queueId)}:write`, body, contentType)
		}

		// --- Components ---
		const SettingsBar = {
			name: 'SettingsBar',
			setup() {
				const url = ref(store.baseUrl)
				const headerName = ref(store.extraHeaderName)
				const headerValue = ref(store.extraHeaderValue)
				function save() {
					store.baseUrl = url.value.trim().replace(/\/$/, '')
					store.extraHeaderName = headerName.value.trim()
					store.extraHeaderValue = headerValue.value.trim()
					localStorage.setItem('tailon.baseUrl', store.baseUrl)
					localStorage.setItem('tailon.headerName', store.extraHeaderName)
					localStorage.setItem('tailon.headerValue', store.extraHeaderValue)
				}
				function testAuth() {
					httpGet('/me').then(() => alert('Auth OK /me')).catch(e => alert('Auth fallo: ' + e.message))
				}
				return { url, headerName, headerValue, save, testAuth }
			},
                        template: `
          <div class="hc-card card-muted">
            <div class="flex items-center gap-3">
              <div class="flex-1">
                <div class="hc-form-label text-sm text-[color:var(--color-text-muted)]">Base URL</div>
                <input v-model="url" class="hc-input" placeholder="https://tailon.hola.cloud" />
              </div>
              <button type="button" @click="save" class="hc-button hc-btn-primary px-4 py-2">Guardar</button>
            </div>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-[0.9fr_1fr_auto_auto] md:items-end">
              <div class="flex flex-col gap-1">
                <label class="hc-form-label text-sm text-[color:var(--color-text-muted)]">Header</label>
                <input v-model="headerName" class="hc-input" placeholder="X-Auth (opcional)" />
              </div>
              <div class="flex flex-col gap-1">
                <label class="hc-form-label text-sm text-[color:var(--color-text-muted)]">Valor</label>
                <input v-model="headerValue" class="hc-input" placeholder="Valor del header" />
              </div>
              <button type="button" @click="save" class="hc-button hc-btn-secondary px-4 py-[10px]">Aplicar</button>
              <button type="button" @click="testAuth" class="hc-button hc-btn-subtle px-4 py-[10px]">Probar /me</button>
            </div>
          </div>
        `
                }

		const Sidebar = {
			name: 'Sidebar',
			components: { SettingsBar },
			setup() {
				const newQueue = ref('')
				const creating = ref(false)
				const router = useRouter()

				function select(q) {
					store.selectedQueue = q
					router.push({ name: 'queue', params: { id: q } })
				}

				async function create() {
					if (!newQueue.value.trim()) return
					creating.value = true
					try {
						await createQueue(newQueue.value.trim())
						newQueue.value = ''
					} catch (e) {
						alert('No se pudo crear la cola: ' + e.message)
					} finally {
						creating.value = false
					}
				}

				onMounted(listQueues)

				return { store, newQueue, creating, listQueues, create, select }
			},
                        template: `
          <aside class="sidebar-panel flex flex-col h-full gap-4 p-5">
            <div class="flex items-center gap-3">
              <img src="img/logo-short.png" alt="hola.cloud" class="h-9 w-9 rounded-lg shadow-sm border border-[color:var(--color-border-subtle)] bg-white/80" />
              <div class="leading-tight">
                <p class="text-xs text-[color:var(--color-text-muted)]">Hola Cloud Admin</p>
                <p class="hc-heading-3 text-lg">Tailon Console</p>
              </div>
              <span class="pill ml-auto">Beta</span>
            </div>

            <SettingsBar />

            <div class="hc-card card-muted">
              <div class="flex flex-col gap-3">
                <div class="flex items-center justify-between">
                  <p class="hc-form-label text-sm mb-0">Nueva cola</p>
                  <button type="button" @click="listQueues" class="hc-button hc-btn-subtle px-3 py-2">Refrescar</button>
                </div>
                <div class="flex gap-2">
                  <input v-model="newQueue" placeholder="Nombre de la cola" class="hc-input" />
                  <button @click="create" :disabled="creating" class="hc-button hc-btn-primary px-4 py-2">Nueva</button>
                </div>
                <p class="hc-helper-text text-sm">Aplica para entornos de pruebas y staging.</p>
              </div>
            </div>

            <nav class="flex-1 overflow-auto card-muted p-3">
              <div class="flex items-center justify-between pb-2">
                <span class="text-xs uppercase tracking-wide text-[color:var(--color-text-muted)]">Colas</span>
                <span class="hc-badge">{{ store.queues.length }} activas</span>
              </div>
              <ul class="divide-y divide-[color:var(--color-border-subtle)]">
                <li v-if="store.loadingQueues" class="py-2 text-sm text-[color:var(--color-text-muted)]">Cargando…</li>
                <li v-else-if="!store.queues.length" class="py-2 text-sm text-[color:var(--color-text-muted)]">No hay colas aún.</li>
                <li v-for="q in store.queues" :key="q">
                  <div class="list-tile flex items-center gap-2 justify-between px-2 py-2 rounded-md transition" :class="{ 'bg-[color:var(--color-surface-muted)]': store.selectedQueue === q }" @click="select(q)">
                    <div class="flex items-center gap-2 min-w-0">
                      <span class="w-2 h-2 rounded-full bg-brand-500"></span>
                      <span class="truncate font-medium">{{ q }}</span>
                    </div>
                    <button title="Eliminar" @click.stop="deleteQueue(q).catch(e=>alert('Error al eliminar: '+e.message))" class="hc-button hc-btn-danger px-2 py-1 text-xs">×</button>
                  </div>
                </li>
              </ul>
            </nav>

            <footer class="text-[11px] text-[color:var(--color-text-muted)]">
              <div class="flex items-center gap-2">
                <span class="inline-flex h-2 w-2 rounded-full bg-brand-500 animate-pulse"></span>
                <span>Listo para conectar con tus colas gestionadas.</span>
              </div>
            </footer>
          </aside>
        `
                }

		const Home = {
			name: 'Home',
                        template: `
          <div class="p-8 h-full bg-[color:var(--color-surface)] flex flex-col items-center justify-center text-center">
            <div class="hc-card card-muted max-w-xl">
              <div class="hc-badge mb-3">hola.cloud</div>
              <h1 class="hc-heading-2 mb-2">Panel de administración</h1>
              <p class="hc-body text-[color:var(--color-text-muted)]">Selecciona una cola en el panel lateral o crea una nueva para empezar a emitir y consumir mensajes.</p>
            </div>
          </div>
        `
                }

		const QueueView = {
			name: 'QueueView',
			setup() {
				const route = useRoute()
				const queueId = computed(() => route.params.id)
				const n = ref(10)
				const timeoutMs = ref(30000)
				const sending = ref(false)
				const contentType = ref('application/json')
				const newMessage = ref('{"hello":"world"}')

				function resetBuffer() {
					store.live.lines = []
					store.live.raw = ''
					store.live.error = ''
				}

				async function readN() {
					resetBuffer()
					try {
						await readJSONLStream(queueId.value, {
							maxLines: Number(n.value) || 1,
							timeoutMs: Number(timeoutMs.value) || 30000,
							onLine(obj, raw) {
								store.live.lines.unshift(obj) // newest first
								store.live.raw += raw + '\n'
							}
						})
					} catch (e) {
						store.live.error = e.message
					}
				}

				async function toggleLive() {
					if (store.live.running) {
						try { store.live.controller?.abort() } catch {}
						store.live.running = false
						return
					}
					resetBuffer()
					store.live.running = true
					try {
						await readJSONLStream(queueId.value, {
							maxLines: Infinity,
							timeoutMs: Infinity,
							onLine(obj, raw) {
								store.live.lines.unshift(obj)
								store.live.raw += raw + '\n'
							}
						})
					} catch (e) {
						store.live.error = e.message
					} finally {
						store.live.running = false
					}
				}

				async function sendMessage() {
					sending.value = true
					try {
						await writeJSONLine(queueId.value, newMessage.value, contentType.value)
					} catch (e) {
						alert('Error al enviar: ' + e.message)
					} finally {
						sending.value = false
					}
				}

				watch(queueId, (v) => {
					store.selectedQueue = v
					resetBuffer()
				}, { immediate: true })

				const curlCmd = computed(() => {
					const url = `${store.baseUrl}/v1/queues/${encodeURIComponent(queueId.value)}:read`
					const header = (store.extraHeaderName && store.extraHeaderValue) ? ` -H "${store.extraHeaderName}: ${store.extraHeaderValue}"` : ''
					return `curl -N -s${header} "${url}"`
				})

				return { store, queueId, n, timeoutMs, newMessage, contentType, readN, toggleLive, sendMessage, curlCmd, resetBuffer }
			},
			template: `
          <div class="h-full flex flex-col bg-[color:var(--color-background)]">
            <div class="p-6 border-b border-[color:var(--color-border-subtle)] bg-[color:var(--color-surface)]">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <p class="text-xs uppercase tracking-wide text-[color:var(--color-text-muted)]">Cola activa</p>
                  <h2 class="hc-heading-3 flex items-center gap-2">{{ queueId }} <span class="hc-tag hc-tag--accent mono text-xs">JSONL</span></h2>
                  <p class="hc-helper-text">Lectura en streaming (JSON Lines) y envío de mensajes.</p>
                </div>
                <div class="flex gap-2">
                  <button @click="resetBuffer" class="hc-button hc-btn-secondary px-4 py-2">Limpiar</button>
                  <button @click="toggleLive" :class="['hc-button px-4 py-2 text-white', store.live.running ? 'hc-btn-danger' : 'hc-btn-primary']">
                    {{ store.live.running ? 'Parar LIVE' : 'LIVE (seguir)' }}
                  </button>
                </div>
              </div>
            </div>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-5 flex-1 overflow-hidden">
              <!-- Controls -->
              <section class="col-span-1 space-y-4 overflow-auto pb-4">
                <div class="hc-card card-muted">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <p class="hc-form-label mb-1">Obtener mensajes</p>
                      <p class="hc-helper-text">Controla lotes y timeout.</p>
                    </div>
                    <span class="hc-badge">Lectura</span>
                  </div>
                  <div class="flex flex-wrap items-end gap-3">
                    <div class="flex-1 min-w-[120px]">
                      <label class="hc-form-label text-sm">Siguientes N</label>
                      <input v-model.number="n" type="number" min="1" class="hc-input" />
                    </div>
                    <div class="flex-1 min-w-[140px]">
                      <label class="hc-form-label text-sm">Timeout (ms)</label>
                      <input v-model.number="timeoutMs" type="number" min="0" class="hc-input" />
                    </div>
                    <button @click="readN" class="hc-button hc-btn-secondary px-4 py-2">Leer</button>
                  </div>
                  <p v-if="store.live.error" class="hc-error-text mt-2">{{ store.live.error }}</p>
                </div>

                <div class="hc-card card-muted">
                  <div class="flex items-center justify-between mb-3">
                    <p class="hc-form-label mb-0">Crear mensaje</p>
                    <select v-model="contentType" class="hc-input w-48">
                      <option>application/json</option>
                      <option>text/plain</option>
                    </select>
                  </div>
                  <textarea v-model="newMessage" rows="8" spellcheck="false" class="hc-input mono text-sm"></textarea>
                  <div class="flex items-center gap-3 justify-between">
                    <p class="hc-helper-text">Se envía como JSONL. Si usas JSON, añadimos un \\n automático.</p>
                    <button @click="sendMessage" :disabled="sending" class="hc-button hc-btn-primary px-4 py-2">Enviar</button>
                  </div>
                </div>

                <div class="hc-card card-muted">
                  <p class="hc-form-label mb-2">cURL (stream)</p>
                  <pre class="code-block text-xs p-4 overflow-auto mono"><code>{{ curlCmd }}</code></pre>
                </div>
              </section>

              <!-- Messages -->
              <section class="col-span-1 lg:col-span-2 flex flex-col min-h-0">
                <div class="hc-card card-muted flex flex-col min-h-0">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <p class="hc-form-label mb-0">Mensajes recibidos</p>
                      <p class="hc-helper-text">{{ store.live.lines.length }} elementos</p>
                    </div>
                    <span class="pill">LIVE {{ store.live.running ? 'ON' : 'OFF' }}</span>
                  </div>
                  <div class="flex-1 overflow-auto rounded-xl border border-[color:var(--color-border-subtle)] bg-[color:var(--color-surface)]">
                    <ul class="divide-y divide-[color:var(--color-border-subtle)]">
                      <li v-for="(m, i) in store.live.lines" :key="i" class="p-3">
                        <pre class="text-xs mono whitespace-pre-wrap">{{ JSON.stringify(m, null, 2) }}</pre>
                      </li>
                      <li v-if="!store.live.lines.length" class="p-6 text-sm text-[color:var(--color-text-muted)]">Sin datos aún. Empieza una lectura o activa LIVE.</li>
                    </ul>
                  </div>
                </div>
              </section>
            </div>
          </div>
        `
		}

		// --- Router ---
		const routes = [
			{ path: '/', name: 'home', component: Home },
			{ path: '/queue/:id', name: 'queue', component: QueueView, props: true },
		]
		const router = createRouter({ history: createWebHashHistory(), routes })

		// --- Root App ---
		const App = {
			name: 'App',
			components: { Sidebar },
			setup() {
				onMounted(() => {
					// pick first queue automatically on load (optional)
					listQueues().then(() => {
						if (store.queues.length && router.currentRoute.value.name === 'home') {
							const q = store.queues[0]
							store.selectedQueue = q
							router.replace({ name: 'queue', params: { id: q } })
						}
					})
				})
				return { store }
			},
                        template: `
          <div class="min-h-screen bg-transparent text-[color:var(--color-text-strong)] p-4 lg:p-8">
            <div class="app-shell grid grid-cols-1 lg:grid-cols-[360px_minmax(0,1fr)]">
              <Sidebar />
              <main class="min-h-0 bg-[color:var(--color-background)]">
                <router-view />
              </main>
            </div>
          </div>
        `
                }

		createApp(App).use(router).mount('#app')
	</script>
</head>
<body>
<div id="app"></div>
</body>
</html>
