<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Tailon Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="stylesheet" href="lib/tailwind.min.css">
    <style>
        :root {
          --color-brand: #5666f5;
          --color-brand-50: #f4f6ff;
          --color-brand-100: #e6e9ff;
          --color-brand-200: #c8d0ff;
          --color-brand-300: #a9b6ff;
          --color-brand-400: #899aff;
          --color-brand-500: #5666f5;
          --color-brand-600: #3a4be6;
          --color-brand-700: #2736c2;
          --color-brand-800: #1d2999;
          --color-brand-900: #131c73;

          --color-accent: #ff7a59;
          --color-success: #16a34a;
          --color-warning: #f59e0b;
          --color-danger: #dc2626;
          --color-neutral-50: #f8fafc;
          --color-neutral-100: #f1f5f9;
          --color-neutral-200: #e2e8f0;
          --color-neutral-300: #cbd5f5;
          --color-neutral-400: #94a3b8;
          --color-neutral-500: #64748b;
          --color-neutral-600: #475569;
          --color-neutral-700: #334155;
          --color-neutral-800: #1e293b;
          --color-neutral-900: #0f172a;

          --color-background: var(--color-neutral-50);
          --color-surface: #ffffff;
          --color-surface-elevated: #ffffff;
          --color-surface-muted: #eef2ff;
          --color-border-subtle: rgba(15, 23, 42, 0.08);
          --color-border-strong: rgba(15, 23, 42, 0.14);
          --color-text-strong: #0f172a;
          --color-text-muted: #475569;
          --color-text-inverse: #f8fafc;
          --focus-ring-color: rgba(86, 102, 245, 0.3);

          --radius-lg: 0.75rem;
          --radius-md: 0.5rem;
          --radius-sm: 0.375rem;

          --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.08);
          --shadow-md: 0 8px 16px rgba(15, 23, 42, 0.12);
          --shadow-lg: 0 16px 32px rgba(15, 23, 42, 0.16);

          color-scheme: light;
          font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
          background-color: var(--color-background);
          color: var(--color-text-strong);
        }

        @media (prefers-color-scheme: dark) {
          :root {
            --color-neutral-50: #0f172a;
            --color-neutral-100: #172554;
            --color-neutral-200: #1d2a5e;
            --color-neutral-300: #24316a;
            --color-neutral-400: #334072;
            --color-neutral-500: #47536f;
            --color-neutral-600: #64748b;
            --color-neutral-700: #94a3b8;
            --color-neutral-800: #cbd5f5;
            --color-neutral-900: #e2e8f0;

            --color-background: #020617;
            --color-surface: #0b1220;
            --color-surface-elevated: #111c30;
            --color-surface-muted: rgba(86, 102, 245, 0.12);
            --color-border-subtle: rgba(148, 163, 184, 0.24);
            --color-border-strong: rgba(148, 163, 184, 0.36);
            --color-text-strong: #f8fafc;
            --color-text-muted: #cbd5f5;
            --color-text-inverse: #020617;
            --focus-ring-color: rgba(86, 102, 245, 0.5);

            color-scheme: dark;
            background-color: var(--color-background);
            color: var(--color-text-strong);
          }
        }

        body {
          margin: 0;
          font-size: 16px;
          line-height: 1.5;
          background-color: var(--color-background);
          color: var(--color-text-strong);
        }

        .hc-card {
          background-color: var(--color-surface-elevated);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-sm);
          padding: 1.25rem;
          border: 1px solid var(--color-border-subtle);
          transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
          display: flex;
          flex-direction: column;
          gap: 1.1rem;
        }

        .hc-card__body {
          display: flex;
          flex-direction: column;
          gap: 0.85rem;
        }

        .hc-card__footer {
          border-color: var(--color-border-subtle);
        }

        .hc-button {
          font-weight: 600;
          border-radius: var(--radius-md);
          border: 1px solid transparent;
          transition: transform 0.15s ease, box-shadow 0.2s ease;
        }

        .hc-button:hover:not(:disabled) {
          transform: translateY(-1px);
        }

        .hc-button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .hc-button:focus-visible {
          outline: none;
          box-shadow: 0 0 0 3px var(--focus-ring-color);
        }

        .hc-btn-primary {
          background: linear-gradient(135deg, var(--color-brand-500), var(--color-brand-600));
          color: #ffffff;
          box-shadow: var(--shadow-sm);
        }

        .hc-btn-primary:hover:not(:disabled) {
          background: linear-gradient(135deg, var(--color-brand-600), var(--color-brand-700));
        }

        .hc-btn-secondary {
          background-color: var(--color-surface);
          color: var(--color-brand-600);
          border-color: rgba(86, 102, 245, 0.35);
        }

        .hc-btn-secondary:hover:not(:disabled) {
          background-color: var(--color-surface-muted);
        }

        .hc-btn-subtle {
          background-color: rgba(86, 102, 245, 0.12);
          color: var(--color-brand-600);
          border-color: transparent;
        }

        .hc-btn-subtle:hover:not(:disabled) {
          background-color: rgba(86, 102, 245, 0.2);
        }

        .hc-btn-danger {
          background-color: var(--color-danger);
          color: #ffffff;
          box-shadow: var(--shadow-sm);
        }

        .hc-btn-danger:hover:not(:disabled) {
          background-color: #b91c1c;
        }

        .hc-form-label {
          font-weight: 500;
          color: var(--color-text-strong);
          margin-bottom: 0.375rem;
        }

        .hc-input-wrapper {
          display: flex;
          flex-direction: column;
          gap: 0.4rem;
          font-size: 0.95rem;
        }

        .hc-input {
          width: 100%;
          border-radius: var(--radius-md);
          border: 1px solid var(--color-border-subtle);
          padding: 0.55rem 0.8rem;
          color: var(--color-text-strong);
          background-color: var(--color-surface);
          transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }

        .hc-input:focus {
          border-color: var(--color-brand-500);
          box-shadow: 0 0 0 3px var(--focus-ring-color);
          outline: none;
        }

        .hc-input::placeholder {
          color: var(--color-text-muted);
          opacity: 0.7;
        }

        .hc-input-error {
          border-color: var(--color-danger);
          box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.18);
        }

        .hc-helper-text {
          font-size: 0.8125rem;
          color: var(--color-text-muted);
        }

        .hc-error-text {
          font-size: 0.8125rem;
          color: var(--color-danger);
          display: flex;
          align-items: center;
          gap: 0.3rem;
        }

        .hc-modal-backdrop {
          background: rgba(15, 23, 42, 0.4);
          backdrop-filter: blur(14px);
        }

        .hc-close-button {
          border-radius: var(--radius-md);
          border: 1px solid transparent;
          background: transparent;
          color: var(--color-text-muted);
          padding: 0.25rem;
          transition: background-color 0.2s ease, color 0.2s ease;
        }

        .hc-close-button:hover {
          background-color: rgba(86, 102, 245, 0.12);
          color: var(--color-brand-600);
        }

        .hc-fade-enter-active,
        .hc-fade-leave-active {
          transition: opacity 0.2s ease;
        }

        .hc-fade-enter-from,
        .hc-fade-leave-to {
          opacity: 0;
        }

        @media (prefers-color-scheme: dark) {
          .hc-card {
            box-shadow: none;
          }

          .hc-btn-secondary {
            color: var(--color-brand-200);
            background-color: rgba(148, 163, 184, 0.08);
            border-color: rgba(148, 163, 184, 0.32);
          }

          .hc-btn-secondary:hover:not(:disabled) {
            background-color: rgba(148, 163, 184, 0.16);
          }

          .hc-btn-subtle {
            background-color: rgba(86, 102, 245, 0.16);
            color: var(--color-brand-100);
          }

          .hc-btn-subtle:hover:not(:disabled) {
            background-color: rgba(86, 102, 245, 0.24);
          }

          .hc-btn-danger {
            box-shadow: none;
          }
        }
    </style>
</head>
<body class="min-h-screen bg-[var(--color-background)] text-[var(--color-text-strong)]">
    <div id="app" class="min-h-screen flex flex-col">
        <header class="border-b border-[var(--color-border-subtle)] bg-[color:var(--color-surface)]/90 backdrop-blur supports-backdrop-blur:bg-[color:var(--color-surface)]/75">
            <div class="mx-auto flex w-full max-w-7xl items-center justify-between px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-[var(--color-brand-500)] to-[var(--color-brand-700)] text-lg font-semibold text-white shadow-md">
                        T
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold tracking-tight">Tailon Console</h1>
                        <p class="text-sm text-[color:var(--color-text-muted)]">Gestiona tus colas en tiempo real</p>
                    </div>
                </div>
                <div class="flex items-center gap-3" v-if="me">
                    <img :src="me.picture" alt="Avatar" class="h-10 w-10 rounded-full object-cover shadow-sm">
                    <div>
                        <p class="text-sm font-semibold">{{ me.nick }}</p>
                        <p class="text-xs text-[color:var(--color-text-muted)]">{{ me.email }}</p>
                    </div>
                    <a href="/auth/logout" class="text-sm font-medium text-[color:var(--color-brand-600)] hover:underline">Salir</a>
                </div>
                <div class="flex items-center gap-3" v-else>
                    <a href="/auth/login" class="text-sm font-semibold text-[color:var(--color-brand-600)] hover:underline">Iniciar sesión</a>
                </div>
            </div>
        </header>
        <div class="flex flex-1 overflow-hidden">
            <aside class="hidden w-80 border-r border-[var(--color-border-subtle)] bg-[color:var(--color-surface)]/70 backdrop-blur xl:block">
                <div class="flex h-full flex-col">
                    <div class="border-b border-[var(--color-border-subtle)] px-6 py-6">
                        <div class="space-y-4">
                            <div>
                                <h2 class="text-lg font-semibold">Colas</h2>
                                <p class="text-sm text-[color:var(--color-text-muted)]">Selecciona una cola para revisar su estado.</p>
                            </div>
                            <hc-input
                                label="Buscar"
                                placeholder="Filtra por nombre"
                                v-model="queueFilter"
                                :help="filteredQueues.length ? '' : 'Crea una nueva cola para comenzar'"
                            ></hc-input>
                            <hc-button class="w-full" @click="openCreateQueue">
                                Crear cola
                            </hc-button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <ul class="space-y-2 px-4 py-4">
                            <li v-if="loadingQueues" class="px-3 py-4 text-sm text-[color:var(--color-text-muted)]">Cargando colas…</li>
                            <li v-else-if="queueError" class="rounded-lg border border-red-200 bg-red-50 px-3 py-3 text-sm text-red-600">{{ queueError }}</li>
                            <li v-else-if="!queues.length" class="px-3 py-3 text-sm text-[color:var(--color-text-muted)]">No hay colas creadas.</li>
                            <li v-else-if="!filteredQueues.length" class="px-3 py-3 text-sm text-[color:var(--color-text-muted)]">No hay resultados para "{{ queueFilter }}".</li>
                            <li v-for="name in filteredQueues" :key="name">
                                <button
                                    type="button"
                                    @click="selectQueue(name)"
                                    class="flex w-full items-center justify-between rounded-lg border px-4 py-3 text-left text-sm transition"
                                    :class="name === selectedQueueName
                                        ? 'border-[color:var(--color-brand-200)] bg-[color:var(--color-brand-100)] font-semibold text-[color:var(--color-brand-700)] shadow-sm'
                                        : 'border-transparent bg-transparent hover:border-[color:var(--color-border-subtle)] hover:bg-[color:var(--color-neutral-100)]'"
                                >
                                    <span class="truncate">{{ name }}</span>
                                    <span v-if="queueDetails && name === queueDetails.name" class="text-xs font-medium text-[color:var(--color-text-muted)]">{{ queueDetails.len ?? 0 }} msgs</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>
            <div class="flex-1 overflow-hidden">
                <div class="mx-auto flex h-full w-full max-w-7xl flex-col gap-6 px-4 py-6 sm:px-6 lg:px-10">
                    <div class="flex flex-col gap-4 xl:hidden">
                        <hc-card>
                            <template #title>
                                <h2 class="text-lg font-semibold">Colas</h2>
                            </template>
                            <div class="space-y-4">
                                <hc-input
                                    label="Buscar"
                                    placeholder="Filtra por nombre"
                                    v-model="queueFilter"
                                ></hc-input>
                                <div class="flex flex-wrap gap-2">
                                    <hc-button class="flex-1" @click="openCreateQueue">Crear cola</hc-button>
                                    <hc-button variant="secondary" class="flex-1" @click="loadQueues(true)">Actualizar lista</hc-button>
                                </div>
                                <div class="max-h-64 space-y-2 overflow-y-auto pr-1">
                                    <div v-if="loadingQueues" class="text-sm text-[color:var(--color-text-muted)]">Cargando colas…</div>
                                    <div v-else-if="queueError" class="rounded-lg border border-red-200 bg-red-50 px-3 py-3 text-sm text-red-600">{{ queueError }}</div>
                                    <div v-else-if="!queues.length" class="text-sm text-[color:var(--color-text-muted)]">No hay colas creadas.</div>
                                    <div v-else-if="!filteredQueues.length" class="text-sm text-[color:var(--color-text-muted)]">No hay resultados para "{{ queueFilter }}".</div>
                                    <button
                                        v-for="name in filteredQueues"
                                        :key="name"
                                        type="button"
                                        @click="selectQueue(name)"
                                        class="flex w-full items-center justify-between rounded-lg border px-4 py-3 text-left text-sm transition"
                                        :class="name === selectedQueueName
                                            ? 'border-[color:var(--color-brand-200)] bg-[color:var(--color-brand-100)] font-semibold text-[color:var(--color-brand-700)] shadow-sm'
                                            : 'border-transparent bg-transparent hover:border-[color:var(--color-border-subtle)] hover:bg-[color:var(--color-neutral-100)]'"
                                    >
                                        <span class="truncate">{{ name }}</span>
                                        <span v-if="queueDetails && name === queueDetails.name" class="text-xs font-medium text-[color:var(--color-text-muted)]">{{ queueDetails.len ?? 0 }} msgs</span>
                                    </button>
                                </div>
                            </div>
                        </hc-card>
                    </div>

                    <div v-if="selectedQueueName" class="space-y-6 pb-10">
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-2xl font-semibold">{{ selectedQueueName }}</h2>
                                <p class="text-sm text-[color:var(--color-text-muted)]">Monitorea métricas y opera sobre esta cola.</p>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <hc-button variant="secondary" @click="loadQueueDetails(true)">Actualizar</hc-button>
                                <hc-button variant="secondary" @click="loadClients(true)">Clientes</hc-button>
                            </div>
                        </div>

                        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
                            <div class="rounded-xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface)] p-4 shadow-sm">
                                <p class="text-sm text-[color:var(--color-text-muted)]">Mensajes en cola</p>
                                <p class="mt-2 text-2xl font-semibold">{{ (queueDetails && queueDetails.len) ?? 0 }}</p>
                            </div>
                            <div class="rounded-xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface)] p-4 shadow-sm">
                                <p class="text-sm text-[color:var(--color-text-muted)]">Mensajes escritos</p>
                                <p class="mt-2 text-2xl font-semibold">{{ (queueDetails && queueDetails.writes) ?? 0 }}</p>
                            </div>
                            <div class="rounded-xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface)] p-4 shadow-sm">
                                <p class="text-sm text-[color:var(--color-text-muted)]">Mensajes leídos</p>
                                <p class="mt-2 text-2xl font-semibold">{{ (queueDetails && queueDetails.reads) ?? 0 }}</p>
                            </div>
                            <div class="rounded-xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface)] p-4 shadow-sm">
                                <p class="text-sm text-[color:var(--color-text-muted)]">Última actualización</p>
                                <p class="mt-2 text-lg font-semibold">{{ formattedQueueUpdated }}</p>
                            </div>
                        </div>

                        <hc-card title="Mensajes" description="Consulta mensajes recientes en formato JSON." class="space-y-4">
                            <template #actions>
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-[color:var(--color-text-muted)]" for="limit-input">Límite</label>
                                        <input
                                            id="limit-input"
                                            type="number"
                                            min="1"
                                            max="1000"
                                            class="hc-input w-24"
                                            v-model.number="readLimit"
                                        />
                                    </div>
                                    <hc-button variant="secondary" :disabled="reading" @click="readMessages">
                                        {{ reading ? 'Leyendo…' : 'Leer mensajes' }}
                                    </hc-button>
                                </div>
                            </template>
                            <div class="space-y-3">
                                <p v-if="readError" class="rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-600">{{ readError }}</p>
                                <p v-else-if="!messages.length" class="text-sm text-[color:var(--color-text-muted)]">No hay mensajes que mostrar. Ejecuta una lectura para ver los más recientes.</p>
                                <div v-else class="space-y-3">
                                    <div class="flex items-center justify-between text-xs text-[color:var(--color-text-muted)]">
                                        <span>Mostrando {{ messages.length }} mensajes</span>
                                        <span>{{ formattedMessagesUpdated }}</span>
                                    </div>
                                    <div class="space-y-3">
                                        <div
                                            v-for="(message, index) in messages"
                                            :key="index"
                                            class="rounded-xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface)] px-4 py-3 text-sm shadow-sm"
                                        >
                                            <pre class="whitespace-pre-wrap break-words text-xs leading-relaxed text-[color:var(--color-text-strong)]">{{ formatMessage(message) }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </hc-card>

                        <hc-card title="Enviar mensaje" description="Escribe un mensaje JSON para insertarlo en la cola.">
                            <div class="space-y-4">
                                <label class="hc-input-wrapper">
                                    <span class="hc-form-label">JSON del mensaje</span>
                                    <textarea
                                        class="hc-input min-h-[140px] font-mono"
                                        placeholder='{"id":123,"payload":"mensaje"}'
                                        v-model="newMessage"
                                    ></textarea>
                                </label>
                                <p v-if="sendError" class="rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-600">{{ sendError }}</p>
                                <div class="flex flex-wrap justify-end gap-3">
                                    <hc-button variant="primary" :disabled="sending" @click="sendMessage">
                                        {{ sending ? 'Enviando…' : 'Enviar mensaje' }}
                                    </hc-button>
                                </div>
                            </div>
                        </hc-card>

                        <hc-card title="Clientes activos" description="Conexiones que están interactuando con las colas.">
                            <div class="space-y-3">
                                <p v-if="clientsError" class="rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-600">{{ clientsError }}</p>
                                <p v-else-if="!activeClients.length" class="text-sm text-[color:var(--color-text-muted)]">No hay clientes activos en esta cola.</p>
                                <div v-else class="divide-y divide-[color:var(--color-border-subtle)] rounded-lg border border-[color:var(--color-border-subtle)] bg-[color:var(--color-surface)]">
                                    <div
                                        v-for="client in activeClients"
                                        :key="client.id"
                                        class="flex flex-col gap-2 px-4 py-3 text-sm sm:flex-row sm:items-center sm:justify-between"
                                    >
                                        <div>
                                            <p class="font-medium">{{ client.ip }}</p>
                                            <p class="text-xs text-[color:var(--color-text-muted)]">Conectado desde {{ formatTimestamp(client.start) }}</p>
                                        </div>
                                        <div class="flex gap-4 text-xs text-[color:var(--color-text-muted)]">
                                            <span><strong class="text-[color:var(--color-text-strong)]">{{ client.reads }}</strong> lecturas</span>
                                            <span><strong class="text-[color:var(--color-text-strong)]">{{ client.writes }}</strong> escrituras</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </hc-card>
                    </div>
                    <div v-else class="flex flex-1 items-center justify-center">
                        <div class="max-w-lg text-center">
                            <h2 class="text-2xl font-semibold">Crea o selecciona una cola</h2>
                            <p class="mt-3 text-sm text-[color:var(--color-text-muted)]">Comienza creando una cola para organizar tus mensajes o elige una existente desde el panel lateral.</p>
                            <div class="mt-6 flex flex-wrap justify-center gap-3">
                                <hc-button @click="openCreateQueue">Crear cola</hc-button>
                                <hc-button variant="secondary" @click="loadQueues(true)">Actualizar lista</hc-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hc-modal v-model="showCreateModal" title="Crear nueva cola" @close="resetCreateModal">
            <div class="space-y-4">
                <hc-input
                    label="Nombre de la cola"
                    placeholder="ej. pedidos-criticos"
                    v-model="newQueueName"
                    :error="createError"
                ></hc-input>
                <p class="text-xs text-[color:var(--color-text-muted)]">Utiliza letras, números y guiones medios. El nombre debe ser único.</p>
            </div>
            <template #footer>
                <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
                    <hc-button variant="secondary" @click="closeCreateQueue">Cancelar</hc-button>
                    <hc-button :disabled="creatingQueue" @click="submitCreateQueue">
                        {{ creatingQueue ? 'Creando…' : 'Crear cola' }}
                    </hc-button>
                </div>
            </template>
        </hc-modal>
    </div>
    <script src="lib/vue.global.prod.js"></script>
    <script>
        const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;

        const variantClasses = {
            primary: 'hc-btn-primary',
            secondary: 'hc-btn-secondary',
            subtle: 'hc-btn-subtle',
            danger: 'hc-btn-danger',
        };

        const HcButton = {
            name: 'HcButton',
            inheritAttrs: false,
            props: {
                variant: { type: String, default: 'primary' },
                type: { type: String, default: 'button' },
                disabled: { type: Boolean, default: false },
            },
            setup(props, { slots, attrs }) {
                return () => {
                    const loading = attrs.loading === '' || attrs.loading === true;
                    const buttonAttrs = {
                        ...attrs,
                        type: props.type,
                        disabled: props.disabled || loading,
                        class: [
                            'hc-button inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-medium transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--color-surface)] focus-visible:ring-[var(--color-brand-400)]',
                            variantClasses[props.variant] || variantClasses.primary,
                            attrs.class || '',
                        ],
                    };
                    delete buttonAttrs.loading;
                    return Vue.h(
                        'button',
                        buttonAttrs,
                        [
                            loading
                                ? Vue.h('span', {
                                      class: 'inline-flex h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent',
                                  })
                                : null,
                            slots.default ? Vue.h('span', { class: 'font-medium' }, slots.default()) : null,
                        ].filter(Boolean)
                    );
                };
            },
        };

        let inputIdCounter = 0;
        const HcInput = {
            name: 'HcInput',
            inheritAttrs: false,
            props: {
                modelValue: [String, Number],
                label: String,
                id: String,
                type: { type: String, default: 'text' },
                variant: { type: String, default: 'text' },
                help: String,
                error: String,
                required: Boolean,
                rows: { type: Number, default: 4 },
                placeholder: String,
            },
            emits: ['update:modelValue'],
            setup(props, { emit, slots, attrs }) {
                const internalId = ref(props.id || `hc-input-${++inputIdCounter}`);
                watch(
                    () => props.id,
                    (value) => {
                        if (value) {
                            internalId.value = value;
                        }
                    }
                );

                const isTextarea = computed(() => props.variant === 'textarea' || attrs.type === 'textarea');

                const onInput = (event) => {
                    emit('update:modelValue', event.target.value);
                };

                return () => {
                    const controlTag = isTextarea.value ? 'textarea' : 'input';
                    const controlAttrs = {
                        ...attrs,
                        id: internalId.value,
                        type: isTextarea.value ? undefined : props.type,
                        rows: isTextarea.value ? props.rows : undefined,
                        value: props.modelValue ?? '',
                        placeholder: props.placeholder,
                        class: ['hc-input', props.error ? 'hc-input-error' : '', attrs.class || ''].join(' ').trim(),
                        required: props.required || attrs.required,
                        onInput,
                    };
                    return Vue.h(
                        'label',
                        { class: 'hc-input-wrapper', for: internalId.value },
                        [
                            props.label
                                ? Vue.h('span', { class: 'hc-form-label' }, [
                                      props.label,
                                      props.required ? Vue.h('span', { class: 'ml-1 text-red-500', 'aria-hidden': 'true' }, '*') : null,
                                  ])
                                : null,
                            Vue.h(controlTag, controlAttrs),
                            props.help && !props.error
                                ? Vue.h('p', { class: 'hc-helper-text' }, props.help)
                                : null,
                            props.error
                                ? Vue.h('p', { class: 'hc-error-text' }, [
                                      Vue.h('span', { 'aria-hidden': 'true' }, '⚠️'),
                                      Vue.h('span', null, props.error),
                                  ])
                                : null,
                            slots.default ? slots.default() : null,
                        ].filter(Boolean)
                    );
                };
            },
        };

        const HcCard = {
            name: 'HcCard',
            props: {
                title: String,
                description: String,
                padding: { type: String, default: '' },
            },
            setup(props, { slots }) {
                const hasHeader = computed(() => Boolean(props.title || props.description || slots.title || slots.actions));
                return () => {
                    const headerChildren = [];
                    if (slots.title) {
                        headerChildren.push(slots.title());
                    } else if (props.title) {
                        headerChildren.push(
                            Vue.h(
                                'h2',
                                {
                                    class: 'truncate text-lg font-semibold',
                                    style: { color: 'var(--color-text-strong)' },
                                },
                                props.title
                            )
                        );
                    }
                    if (props.description) {
                        headerChildren.push(
                            Vue.h(
                                'p',
                                {
                                    class: 'text-sm',
                                    style: { color: 'var(--color-text-muted)' },
                                },
                                props.description
                            )
                        );
                    }
                    const header = hasHeader.value
                        ? Vue.h(
                              'header',
                              { class: 'flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between' },
                              [
                                  Vue.h('div', { class: 'min-w-0 space-y-1' }, headerChildren),
                                  slots.actions ? Vue.h('div', { class: 'flex items-center gap-3' }, slots.actions()) : null,
                              ]
                          )
                        : null;
                    const body = Vue.h('div', { class: ['hc-card__body', props.padding, ''].join(' ').trim() }, slots.default ? slots.default() : []);
                    const footer = slots.footer
                        ? Vue.h('footer', { class: 'hc-card__footer border-t pt-4' }, slots.footer())
                        : null;
                    return Vue.h('section', { class: ['hc-card', slots.default && slots.default().length === 0 ? 'p-6' : ''].join(' ').trim() }, [
                        header,
                        body,
                        footer,
                    ]);
                };
            },
        };

        const HcModal = {
            name: 'HcModal',
            props: {
                modelValue: { type: Boolean, default: false },
                title: String,
            },
            emits: ['update:modelValue', 'close'],
            setup(props, { emit, slots }) {
                const close = () => {
                    emit('update:modelValue', false);
                    emit('close');
                };
                const onBackdrop = (event) => {
                    if (event.target === event.currentTarget) {
                        close();
                    }
                };
                const onKey = (event) => {
                    if (event.key === 'Escape' && props.modelValue) {
                        close();
                    }
                };
                onMounted(() => {
                    window.addEventListener('keydown', onKey);
                });
                onUnmounted(() => {
                    window.removeEventListener('keydown', onKey);
                });
                return () =>
                    Vue.h(
                        Vue.Teleport,
                        { to: 'body' },
                        Vue.h(
                            Vue.Transition,
                            { name: 'hc-fade' },
                            () =>
                                props.modelValue
                                    ? Vue.h(
                                          'div',
                                          {
                                              class: 'hc-modal-backdrop fixed inset-0 z-50 flex items-center justify-center px-4 py-8',
                                              onClick: onBackdrop,
                                          },
                                          [
                                              Vue.h(
                                                  'div',
                                                  {
                                                      class: 'w-full max-w-lg rounded-2xl border border-[var(--color-border-subtle)] bg-[color:var(--color-surface-elevated)]/90 p-6 shadow-2xl backdrop-blur-xl',
                                                      onClick: (event) => event.stopPropagation(),
                                                  },
                                                  [
                                                      Vue.h('div', { class: 'flex items-start justify-between gap-4' }, [
                                                          Vue.h('div', { class: 'space-y-1' }, [
                                                              props.title
                                                                  ? Vue.h(
                                                                        'h3',
                                                                        {
                                                                            class: 'text-xl font-semibold text-[color:var(--color-text-strong)]',
                                                                        },
                                                                        props.title
                                                                    )
                                                                  : null,
                                                              slots.subtitle ? Vue.h('p', { class: 'text-sm text-[color:var(--color-text-muted)]' }, slots.subtitle()) : null,
                                                          ].filter(Boolean)),
                                                          Vue.h(
                                                              'button',
                                                              {
                                                                  type: 'button',
                                                                  class: 'hc-close-button',
                                                                  onClick: close,
                                                                  'aria-label': 'Cerrar',
                                                              },
                                                              [
                                                                  Vue.h(
                                                                      'svg',
                                                                      {
                                                                          xmlns: 'http://www.w3.org/2000/svg',
                                                                          viewBox: '0 0 24 24',
                                                                          class: 'h-5 w-5',
                                                                          fill: 'none',
                                                                          stroke: 'currentColor',
                                                                          'stroke-width': 2,
                                                                      },
                                                                      [
                                                                          Vue.h('path', {
                                                                              d: 'M6 6l12 12M18 6L6 18',
                                                                              'stroke-linecap': 'round',
                                                                              'stroke-linejoin': 'round',
                                                                          }),
                                                                      ]
                                                                  ),
                                                              ]
                                                          ),
                                                      ]),
                                                      Vue.h('div', { class: 'mt-6' }, slots.default ? slots.default() : null),
                                                      Vue.h(
                                                          'div',
                                                          { class: 'mt-6 flex flex-col gap-3 sm:flex-row sm:justify-end' },
                                                          slots.footer ? slots.footer() : [
                                                              Vue.h(
                                                                  HcButton,
                                                                  {
                                                                      variant: 'secondary',
                                                                      onClick: close,
                                                                  },
                                                                  { default: () => 'Cerrar' }
                                                              ),
                                                          ]
                                                      ),
                                                  ]
                                              ),
                                          ]
                                      )
                                    : null
                        )
                    );
            },
        };

        function parseJsonLines(text) {
            return text
                .split(/\n+/)
                .map((line) => line.trim())
                .filter(Boolean)
                .map((line) => {
                    try {
                        return JSON.parse(line);
                    } catch (error) {
                        return { error: 'No se pudo parsear', raw: line };
                    }
                });
        }

        function formatDate(date) {
            if (!date) return '';
            const d = typeof date === 'string' ? new Date(date) : date;
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleString();
        }

        const app = createApp({
            components: { HcButton, HcInput, HcCard, HcModal },
            setup() {
                const queues = ref([]);
                const queueFilter = ref('');
                const loadingQueues = ref(false);
                const queueError = ref('');
                const selectedQueueName = ref('');
                const queueDetails = ref(null);
                const queueUpdatedAt = ref(null);
                const showCreateModal = ref(false);
                const newQueueName = ref('');
                const createError = ref('');
                const creatingQueue = ref(false);
                const messages = ref([]);
                const readLimit = ref(20);
                const reading = ref(false);
                const readError = ref('');
                const messagesUpdatedAt = ref(null);
                const newMessage = ref('');
                const sending = ref(false);
                const sendError = ref('');
                const me = ref(null);
                const clients = ref([]);
                const clientsError = ref('');

                let queuesInterval = null;
                let detailsInterval = null;

                const filteredQueues = computed(() => {
                    if (!queueFilter.value) {
                        return queues.value.slice();
                    }
                    const query = queueFilter.value.toLowerCase();
                    return queues.value.filter((name) => name.toLowerCase().includes(query));
                });

                const formattedQueueUpdated = computed(() => formatDate(queueUpdatedAt.value));
                const formattedMessagesUpdated = computed(() => formatDate(messagesUpdatedAt.value));
                const activeClients = computed(() => {
                    if (!selectedQueueName.value) return [];
                    return clients.value.filter((client) => client.queue === selectedQueueName.value);
                });

                const formatMessage = (message) => {
                    try {
                        return JSON.stringify(message, null, 2);
                    } catch (error) {
                        return String(message);
                    }
                };

                const formatTimestamp = (value) => formatDate(value);

                async function loadQueues(silent = false) {
                    if (!silent) {
                        loadingQueues.value = true;
                        queueError.value = '';
                    }
                    try {
                        const response = await fetch('/v1/queues');
                        if (!response.ok) {
                            throw new Error('No se pudo obtener la lista de colas');
                        }
                        const data = await response.json();
                        queues.value = Array.isArray(data) ? data.slice().sort() : [];
                        if (!selectedQueueName.value && queues.value.length) {
                            selectQueue(queues.value[0]);
                        }
                    } catch (error) {
                        queueError.value = error.message || 'Error cargando colas';
                    } finally {
                        loadingQueues.value = false;
                    }
                }

                async function loadQueueDetails(silent = false) {
                    if (!selectedQueueName.value) return;
                    if (!silent) {
                        queueDetails.value = queueDetails.value;
                    }
                    try {
                        const response = await fetch(`/v1/queues/${encodeURIComponent(selectedQueueName.value)}`);
                        if (!response.ok) {
                            throw new Error('No se pudo obtener la cola seleccionada');
                        }
                        const data = await response.json();
                        queueDetails.value = data;
                        queueUpdatedAt.value = new Date();
                    } catch (error) {
                        queueDetails.value = null;
                        queueUpdatedAt.value = null;
                    }
                }

                async function loadClients(silent = false) {
                    if (!silent) {
                        clientsError.value = '';
                    }
                    try {
                        const response = await fetch('/v1/clients');
                        if (!response.ok) {
                            throw new Error('No se pudieron obtener los clientes activos');
                        }
                        const data = await response.json();
                        const list = Object.keys(data || {}).map((key) => ({ id: key, ...data[key] }));
                        clients.value = list;
                    } catch (error) {
                        if (!silent) {
                            clientsError.value = error.message || 'No se pudo cargar la información de clientes';
                        }
                    }
                }

                async function readMessages() {
                    if (!selectedQueueName.value) return;
                    reading.value = true;
                    readError.value = '';
                    try {
                        const response = await fetch(`/v1/queues/${encodeURIComponent(selectedQueueName.value)}:read`, {
                            headers: {
                                Limit: String(Math.max(1, Math.min(1000, readLimit.value || 1))),
                            },
                        });
                        if (!response.ok) {
                            throw new Error('No se pudo leer la cola');
                        }
                        const text = await response.text();
                        messages.value = parseJsonLines(text);
                        messagesUpdatedAt.value = new Date();
                    } catch (error) {
                        readError.value = error.message || 'Error leyendo mensajes';
                    } finally {
                        reading.value = false;
                    }
                }

                async function sendMessage() {
                    if (!selectedQueueName.value) return;
                    sendError.value = '';
                    if (!newMessage.value.trim()) {
                        sendError.value = 'Introduce un JSON válido antes de enviar.';
                        return;
                    }
                    let payload;
                    try {
                        payload = JSON.parse(newMessage.value);
                    } catch (error) {
                        sendError.value = 'El mensaje debe ser un JSON válido.';
                        return;
                    }
                    sending.value = true;
                    try {
                        const response = await fetch(`/v1/queues/${encodeURIComponent(selectedQueueName.value)}:write`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                        });
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || 'No se pudo enviar el mensaje');
                        }
                        newMessage.value = '';
                        await loadQueueDetails(true);
                    } catch (error) {
                        sendError.value = error.message || 'Error enviando el mensaje';
                    } finally {
                        sending.value = false;
                    }
                }

                function openCreateQueue() {
                    createError.value = '';
                    showCreateModal.value = true;
                }

                function closeCreateQueue() {
                    showCreateModal.value = false;
                }

                function resetCreateModal() {
                    newQueueName.value = '';
                    createError.value = '';
                }

                async function submitCreateQueue() {
                    const name = newQueueName.value.trim();
                    if (!name) {
                        createError.value = 'El nombre es obligatorio';
                        return;
                    }
                    if (!/^[-a-zA-Z0-9]+$/.test(name)) {
                        createError.value = 'Usa solo letras, números y guiones medios';
                        return;
                    }
                    creatingQueue.value = true;
                    createError.value = '';
                    try {
                        const response = await fetch('/v1/queues', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name }),
                        });
                        if (!response.ok) {
                            let message = 'No se pudo crear la cola';
                            try {
                                const payload = await response.json();
                                message = payload.error?.description || payload.error?.message || message;
                            } catch (err) {
                                const text = await response.text();
                                message = text || message;
                            }
                            throw new Error(message);
                        }
                        showCreateModal.value = false;
                        newQueueName.value = '';
                        await loadQueues(true);
                        selectQueue(name);
                    } catch (error) {
                        createError.value = error.message || 'Error creando la cola';
                    } finally {
                        creatingQueue.value = false;
                    }
                }

                function selectQueue(name) {
                    if (selectedQueueName.value === name) return;
                    selectedQueueName.value = name;
                    messages.value = [];
                    readError.value = '';
                    messagesUpdatedAt.value = null;
                    loadQueueDetails();
                    loadClients(true);
                    restartDetailsInterval();
                }

                function restartDetailsInterval() {
                    if (detailsInterval) {
                        clearInterval(detailsInterval);
                    }
                    if (!selectedQueueName.value) return;
                    detailsInterval = setInterval(() => {
                        loadQueueDetails(true);
                        loadClients(true);
                    }, 5000);
                }

                async function fetchMe() {
                    try {
                        const response = await fetch('/auth/me');
                        if (!response.ok) return;
                        const data = await response.json();
                        if (!data.error) {
                            me.value = data;
                        }
                    } catch (error) {
                        /* ignore auth errors */
                    }
                }

                onMounted(() => {
                    loadQueues();
                    loadClients(true);
                    fetchMe();
                    queuesInterval = setInterval(() => loadQueues(true), 15000);
                });

                onUnmounted(() => {
                    if (queuesInterval) clearInterval(queuesInterval);
                    if (detailsInterval) clearInterval(detailsInterval);
                });

                watch(selectedQueueName, (name) => {
                    if (!name && detailsInterval) {
                        clearInterval(detailsInterval);
                    }
                });

                return {
                    queues,
                    queueFilter,
                    loadingQueues,
                    queueError,
                    filteredQueues,
                    selectQueue,
                    selectedQueueName,
                    queueDetails,
                    formattedQueueUpdated,
                    formattedMessagesUpdated,
                    readLimit,
                    readMessages,
                    reading,
                    messages,
                    formatMessage,
                    readError,
                    messagesUpdatedAt,
                    newMessage,
                    sendMessage,
                    sending,
                    sendError,
                    openCreateQueue,
                    closeCreateQueue,
                    resetCreateModal,
                    showCreateModal,
                    newQueueName,
                    createError,
                    creatingQueue,
                    submitCreateQueue,
                    me,
                    loadQueues,
                    loadQueueDetails,
                    loadClients,
                    clientsError,
                    activeClients,
                    formatTimestamp,
                };
            },
        });

        app.component('hc-button', HcButton);
        app.component('hc-input', HcInput);
        app.component('hc-card', HcCard);
        app.component('hc-modal', HcModal);

        app.mount('#app');
    </script>
</body>
</html>
